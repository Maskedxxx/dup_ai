# Шаг 3: Предварительная обработка (внутри контура пайплайна)

## Вход
- DataFrame: результат нормализации (Шаг 2).
- button: тип кнопки (`contractors | risks | errors | processes`).
- kwargs: дополнительные параметры от API (например, `risk_category` для `risks`).

## Что происходит внутри
- Вызов `BasePipeline._pre_process_dataframe(df, **kwargs)` с возможным переопределением в конкретном пайплайне.
- Цель: сузить или адаптировать данные перед классификацией, не меняя общую схему колонок.

### По доменам
- Risks: фильтрация по категории риска (значение `risk_category` сравнивается с `project_type`).
  - Где: `RisksPipeline._pre_process_dataframe()`.
  - Поведение: если категория не задана — данные не фильтруются; если заданы и не найдены записи — возвращается пустой DataFrame (будет ранний «пустой» ответ).
- Contractors, Errors, Processes: на данный момент доп. предобработка не задана — используется реализация по умолчанию (возвращает исходный DataFrame без изменений).

### Ранний выход (важно)
- Если после предобработки данных нет (`len(processed_df) == 0`), пайплайн немедленно формирует корректный «пустой» ответ без дальнейших шагов.
- Где: `BasePipeline.process()` (после вызова `_pre_process_dataframe`).

## Логирование
- Логируются: входные параметры предобработки, размер DataFrame до/после, предупреждения при отсутствии данных.
- Где: `PipelineLogger` внутри `BasePipeline.process()` и соответствующих методов пайплайнов.

## Выход
- DataFrame: предобработанный набор записей (возможно отфильтрованный).
- Если пусто: формируется ранний «пустой» ответ (текст + `total_found=0`, пустые `items`).

## Где в коде
- Каркас шага: `app/pipelines/base.py` (`_pre_process_dataframe`, блок «ШАГ 3: Предварительная обработка»).
- Реализация по умолчанию: `BasePipeline._pre_process_dataframe()` (возвращает `df`).
- Доменные переопределения: `app/pipelines/risks_pipeline.py` (фильтрация по `risk_category`).

## Почему так
- Гибкость: даёт место для лёгкого доменного сужения перед затратными шагами (классификация, LLM).
- Производительность: ранний выход экономит ресурсы при отсутствии релевантных данных.

