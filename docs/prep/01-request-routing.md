# Предшаг: выбор кнопки и отправка запроса (маршрутизация)

## Что делает пользователь
- Выбирает кнопку: `contractors`, `risks`, `errors`, `processes`.
- Пишет вопрос простыми словами.
- Для `risks` при необходимости указывает `risk_category`.
- Отправляет запрос на API.

## Что делает система до шага «Загрузка данных»
1) Принимает запрос
- Эндпоинт: `POST /v1/ask`.
- Схемы: `AskRequest`, `AskResponse` (строгая валидация через Pydantic).
- Код: `app/api/v1/endpoints.py`, `app/api/v1/schemas.py`.

2) Проверяет и настраивает параметры
- Валидирует тип кнопки; логирует запрос.
- Читает `limit` из query или берёт defaults из настроек для каждой кнопки.
- Код: `endpoints.py` + настройки в `app/config.py` (`Contractor/Risk/Error/ProcessSettings`).

3) Выбирает и создаёт пайплайн
- По кнопке выбирается класс пайплайна (`Contractors/Risks/Errors/ProcessesPipeline`).
- DI-контейнер создаёт зависимости: `ExcelLoader`, сервисы нормализации/классификации/генерации, `ToolExecutor`.
- Код: `get_pipeline(...)` и фабрики в `app/pipelines/__init__.py`, контейнер в `app/config.py`.

4) Делегирует обработку
- Вызывает `pipeline.process(question, ...)`.
- На этом моменте начинается Шаг 1 пайплайна — «Загрузка данных» (чтение Excel).
- Код: `BasePipeline.process()` в `app/pipelines/base.py` (пронумерованные шаги).

5) Обрабатывает ошибки
- В случае исключений формирует понятный `AskResponse` с текстом ошибки.
- Код: блок `try/except` в `endpoints.py`.

## Форматы запрос/ответ
- Вход (AskRequest):
  - `question: str`, `button: contractors|risks|errors|processes`, `risk_category?: str (для risks)`.
- Выход (AskResponse):
  - `text`, `query`, `total_found`, `items[]`, `meta?`, `category?`.

## Почему так
- Единый вход: одна точка входа для всех кнопок — проще клиентам и поддержке.
- Разделение слоёв: API только маршрутизирует; доменная логика — в пайплайнах.
- Типобезопасность: Pydantic-схемы гарантируют корректные данные.
- Расширяемость: новый тип кнопки добавляется через новый пайплайн и маппинг.

## Примечания
- Для `risks` `risk_category` сужает контекст ответа.
- Если `limit` не указан, берётся значение из настроек для соответствующей кнопки.
- Логи пишутся в единый файл `LOGS/dup_ai.log`.
