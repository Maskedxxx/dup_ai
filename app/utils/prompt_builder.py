from typing import List, Dict, Any

class PromptBuilder:
    """
    Утилита для построения промптов для LLM.
    """
    
    @staticmethod
    def build_classification_prompt(question: str, work_types: List[str]) -> Dict[str, str]:
        """
        Строит системный и пользовательский промпты для классификации запроса.
        
        :param question: Вопрос пользователя
        :param work_types: Список типов работ
        :return: Словарь с ключами 'system' и 'user' для промптов
        """
        # Системный промпт
        system_prompt = f"""Ты эксперт по классификации запросов в участии подрядчиков в проектах.
        
        Твоя задача: определить, к какому проекту из предоставленного списка наиболее релевантен запрос пользователя.
        
        Список возможных проектов:
        {', '.join(work_types)}
        
        Проанализируй запрос и выполни следующие действия:
        1. Проведи краткое рассуждение о том, к каким проектам может относиться запрос
        2. Определи топ-3 наиболее релевантных проекта и дай им оценки от 0 до 1
        
        Важно: выбирай только из предоставленного списка проектов, не добавляй свои варианты.
        """
        
        # Пользовательский промпт
        example_project = work_types[0] if work_types else "Бетонные конструкции"
        
        user_prompt = f"""
        Запрос пользователя: "{question}"
        
        Определи, к какому проекту из списка наиболее релевантен этот запрос.
        
        Верни ответ в структурированном формате. Например:
        
        ```json
        {{
            "reasoning": "Запрос касается установки и подключения электрооборудования в здании",
            "top_projects": {{
                "{example_project}": 0.9,
                "{work_types[1] if len(work_types) > 1 else 'Инженерные системы'}": 0.6,
                "{work_types[2] if len(work_types) > 2 else 'Проектирование зданий'}": 0.3
            }}
        }}
        ```
        """
        
        return {
            'system': system_prompt,
            'user': user_prompt
        }
    
    @staticmethod
    def build_answer_prompt(question: str, documents: List[Dict[str, Any]], additional_context: str = "") -> Dict[str, str]:
        """
        Строит системный и пользовательский промпты для генерации ответа.
        
        :param question: Вопрос пользователя
        :param documents: Список документов с данными о подрядчиках
        :param additional_context: Дополнительный контекст
        :return: Словарь с ключами 'system' и 'user' для промптов
        """
        # Системный промпт
        system_prompt = """Ты профессиональный аналитик по подбору подрядчиков для строительных и инженерных проектов.
        
        Твоя задача: дать информативный ответ на запрос пользователя о подрядчиках на основе предоставленных данных.
        
        Ответ должен быть:
        1. Структурированным и информативным
        2. Содержать ключевую информацию о подрядчиках
        3. Отформатирован в виде Markdown
        4. Включать рекомендации при необходимости
        
        Не включай в ответ информацию, которой нет в предоставленных данных.
        """
        
        # Форматируем документы для промпта
        formatted_docs = ""
        for i, doc in enumerate(documents, 1):
            formatted_docs += f"### Подрядчик {i}:\n"
            formatted_docs += f"{doc['content']}\n"
            
            # Добавляем метаданные
            if doc.get('metadata'):
                for key, value in doc['metadata'].items():
                    if value:
                        formatted_docs += f"{key}: {value}\n"
            
            formatted_docs += "\n---\n\n"
        
        # Пользовательский промпт
        user_prompt = f"""
        Запрос пользователя: "{question}"
        
        Дополнительный контекст: {additional_context}
        
        Данные о подрядчиках:
        
        {formatted_docs}
        
        Сгенерируй подробный и информативный ответ на запрос пользователя, используя предоставленные данные.
        """
        
        return {
            'system': system_prompt,
            'user': user_prompt
        }
        
        
    @staticmethod
    def build_risk_project_classification_prompt(question: str, project_names: List[str]) -> Dict[str, str]:
        """
        Строит системный и пользовательский промпты для классификации запроса о рисках по проектам.
        
        :param question: Вопрос пользователя
        :param project_names: Список названий проектов
        :return: Словарь с ключами 'system' и 'user' для промптов
        """
        # Системный промпт
        system_prompt = f"""Ты эксперт по классификации запросов о рисках в проектах.
        
        Твоя задача: определить, к какому проекту из предоставленного списка наиболее релевантен запрос пользователя о рисках.
        
        Список возможных проектов:
        {', '.join(project_names)}
        
        Проанализируй запрос и выполни следующие действия:
        1. Проведи краткое рассуждение о том, к каким проектам может относиться запрос
        2. Определи топ-3 наиболее релевантных проекта и дай им оценки от 0 до 1
        
        Важно: выбирай только из предоставленного списка проектов, не добавляй свои варианты.
        """
        
        # Пользовательский промпт
        example_project = project_names[0] if project_names else "Проект разработки ПО"
        
        user_prompt = f"""
        Запрос пользователя о рисках: "{question}"
        
        Определи, к какому проекту из списка наиболее релевантен этот запрос.
        
        Верни ответ в структурированном формате. Например:
        
        {{
            "reasoning": "Запрос касается рисков при проведении испытаний новых компонентов",
            "top_projects": {{
                "{example_project}": 0.9,
                "{project_names[1] if len(project_names) > 1 else 'Проект строительства'}": 0.6,
                "{project_names[2] if len(project_names) > 2 else 'Проект внедрения'}": 0.3
            }}
        }}
        """
        
        return {
            'system': system_prompt,
            'user': user_prompt
        }

    @staticmethod
    def build_risk_answer_prompt(question: str, risks: List[Dict[str, Any]], category: str, additional_context: str = "") -> Dict[str, str]:
        """
        Строит системный и пользовательский промпты для генерации ответа о рисках.
        
        :param question: Вопрос пользователя
        :param risks: Список рисков
        :param category: Категория риска
        :param additional_context: Дополнительный контекст
        :return: Словарь с ключами 'system' и 'user' для промптов
        """
        # Системный промпт
        system_prompt = """Ты эксперт по анализу рисков в проектах разных типов.
        
        Твоя задача: дать информативный ответ на запрос пользователя о рисках проектов на основе предоставленных данных.
        
        Ответ должен быть:
        1. Структурированным и информативным
        2. Содержать ключевую информацию о рисках и проектах
        3. Отформатирован в виде Markdown
        4. Включать рекомендации и выводы при необходимости
        
        Не включай в ответ информацию, которой нет в предоставленных данных.
        """
        
        # Форматируем данные о рисках для промпта
        formatted_risks = ""
        for i, risk in enumerate(risks, 1):
            formatted_risks += f"### Риск {i}:\n"
            formatted_risks += f"**Проект**: {risk.get('project_name', '')}\n"
            formatted_risks += f"**Описание риска**: {risk.get('risk_text', '')}\n"
            
            # Добавляем дополнительные поля, если они есть
            if risk.get('risk_priority'):
                formatted_risks += f"**Приоритет**: {risk.get('risk_priority')}\n"
            if risk.get('status'):
                formatted_risks += f"**Статус**: {risk.get('status')}\n"
            
            formatted_risks += "\n---\n\n"
        
        # Соответствие категорий
        category_names = {
            "niokr": "НИОКР (научно-исследовательские и опытно-конструкторские работы)",
            "product_project": "Продуктовые проекты",
            "manufacturing": "Производство"
        }
        
        category_name = category_names.get(category, category)
        
        # Пользовательский промпт
        user_prompt = f"""
        Запрос пользователя: "{question}"
        
        Категория проектов: {category_name}
        
        {additional_context}
        
        Данные о рисках:
        
        {formatted_risks}
        
        Сгенерируй подробный и информативный ответ на запрос пользователя, используя предоставленные данные о рисках.
        Включи в ответ анализ рисков, их приоритетность и статус, а также рекомендации по управлению рисками, если возможно.
        """
        
        return {
            'system': system_prompt,
            'user': user_prompt
        }